<head>
	<title>simpleRTS</title>
	<link rel="stylesheet" type="text/css" href="client/style.css">
</head>

<div id="loginScreenDiv">
	<div id="gameNameDiv">
		simpleRTS
	</div>
	<div id="enterNameDiv">
		Your name
		<input id="nameInput" type="text" placeholder="Enter your nickname" maxlength="18"></input><br>
		<button id="loginButton">Login</button>
	</div>
</div>

<div id="lobbyScreenDiv">
	<div id="lobbyHeaderDiv">
		simpleRTS
		<button id="logoutButton">Logout</button>
	</div>
	<div id="gamesListContainerDiv">
		<b>Open games (click to join)</b>
		<div id="gamesListDiv"></div>
		<button id="openRoomButton">Create new game</button>
	</div>
	<div id="lobbyChatContainerDiv">
		<b>&nbsp;Chat</b>
		<div id="lobbyChatDiv"></div>
		<input id="lobbyChatInput" type="text" placeholder="Enter your message"></input>
	</div>
	<div id="playersListContainerDiv">
		<b>All players</b>
		<div id="playersListDiv"></div>
	</div>
</div>

<div id="roomScreenDiv">
	<div id="roomHeaderDiv">
		simpleRTS
		<button id="closeTheGameButton">Close the game</button>
		<button id="leaveTheGameButton">Leave the game</button>
	</div>
	<div id="gameOptionsContainerDiv">
		<b>Game options</b>
		
		<div id="gameOptionsDiv">
			<input type="checkbox" id="showRangesCheckbox" value="showRanges"> Show units / turrets range
			<br>
			<input type="checkbox" id="repairUnitsCheckbox" value="repairUnits"> Base can repair units
		</div>
		
		<hr id="gameOprtionsHr">
		
		<b>Map</b>
		<div id="mapDiv">
		<button id="map1Button">Map 1</button>
		<br>
		<button id="map2Button">Map 2</button>
		<br>
		<button id="map3Button">Map 3</button>
		<br>
		<button id="map4Button">Map 4</button>
		</div>
		

		<button id="startGameButton" disabled>Start the game</button>
		<button id="readyGameButton">I'm ready</button>
	</div>
	<div id="roomChatContainerDiv">
		<b>&nbsp;Chat</b>
		<div id="roomChatDiv"></div>
		<input id="roomChatInput" type="text" placeholder="Enter your message"></input>
	</div>
	<div id="roomPlayersListContainerDiv">
		<b>Players</b>
		<div id="roomPlayersListDiv"></div>
	</div>
</div>

<div id="gameDiv">
	<div id="gameTopBarDiv">
		<div id="creditsDiv"></div>
		<div id="unitButtonsDiv">
			<button id="unit1Button" class="unitButton"><img id="unit1ButtonImage" class="unitImage" src="client/img/unit1.png"><span class="unitLabel">&nbsp;$500</span></button>
			<button id="unit2Button" class="unitButton"><img id="unit2ButtonImage" class="unitImage" src="client/img/unit1.png"><span class="unitLabel">&nbsp;$250</span></button>
			<button id="unit3Button" class="unitButton"><img id="unit3ButtonImage" class="unitImage" src="client/img/unit1.png"><span class="unitLabel">&nbsp;$750</span></button>
			<button id="unit4Button" class="unitButton"><img id="unit4ButtonImage" class="unitImage" src="client/img/unit1.png"><span class="unitLabel">&nbsp;$1500</span></button>
		</div>
		<div id="progressBarDiv">
			<div id="progressBarBackground"></div>
			<div id="progressBarProgress"></div>
		</div>
		
		<div id="playersNamesDiv"></div>
		<button id="surrenderButton">Surrender</button>
	</div>
	
	<canvas id="gameCanvas" width="1200" height="568" tabindex='1'></canvas>
	<div id="endGameMessageDiv">
		<div id="endGameMessageBoxDiv"></div>
		<button id="endGameMessageButton">Exit to lobby</button>
	</div>
	
</div>




<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>
	var socket = io();
	var selfId = "";
	var gameId = "";
	var credits = "";
	var unit1Cost = 500;
	var unit2Cost = 250;
	var unit3Cost = 750;
	var unit4Cost = 1500;
	var showRanges = true;
	var repairUnits = true;
	
	var mouseStartX = 0;
	var mouseStartY = 0;
	var mouseEndX = 0;
	var mouseEndY = 0;
	var isMouseLeftKeyDown = false;
	var isMouseRightKeyDown = false;
	var topLeftX = 0;
	var topLeftY = 0;
	var bottomRightX = 0;
	var bottomRightY = 0;
	
	var myBase = null;
	var enemyBase = null;
	var mines = null;
	var turrets = null;
	var myUnits = null;
	var enemyUnits = null;
	var existingExplosions = {};
	
	var keys = {
		_1: false,
		_2: false,
		_3: false,
		_4: false,
		shift: false,
		q: false,
		w: false,
		e: false,
		r: false,
	};
	
	var isBattleUnitSelected = false;
	var isEngineerUnitSelected = false;
	
	window.onbeforeunload = function() {
		socket.disconnect(); 
	}
	
	var loginScreenDiv = document.getElementById("loginScreenDiv");
	var nameInput = document.getElementById("nameInput");
	var loginButton = document.getElementById("loginButton");
	
	var lobbyScreenDiv = document.getElementById("lobbyScreenDiv");
	var openRoomButton = document.getElementById("openRoomButton");
	var logoutButton = document.getElementById("logoutButton");
	var lobbyChatDiv = document.getElementById("lobbyChatDiv");
	var lobbyChatInput = document.getElementById("lobbyChatInput");
	var playersListDiv = document.getElementById("playersListDiv");
	
	var roomScreenDiv = document.getElementById("roomScreenDiv");
	var closeTheGameButton = document.getElementById("closeTheGameButton");
	var leaveTheGameButton = document.getElementById("leaveTheGameButton");
	var roomPlayersListDiv = document.getElementById("roomPlayersListDiv");
	var roomChatDiv = document.getElementById("roomChatDiv");
	var roomChatInput = document.getElementById("roomChatInput");
	var startGameButton = document.getElementById("startGameButton");
	var readyGameButton = document.getElementById("readyGameButton");
	var showRangesCheckbox = document.getElementById("showRangesCheckbox");
	var repairUnitsCheckbox = document.getElementById("repairUnitsCheckbox");
	
	var gameDiv = document.getElementById("gameDiv");
	var creditsDiv = document.getElementById("creditsDiv");
	var playersNamesDiv = document.getElementById("playersNamesDiv");
	var surrenderButton = document.getElementById("surrenderButton");
	
	var endGameMessageDiv = document.getElementById("endGameMessageDiv");
	var endGameMessageBoxDiv = document.getElementById("endGameMessageBoxDiv");
	var endGameMessageButton = document.getElementById("endGameMessageButton");
	var gameCanvas = document.getElementById("gameCanvas").getContext("2d");
	var unit1Button = document.getElementById("unit1Button");
	var unit2Button = document.getElementById("unit2Button");
	var unit3Button = document.getElementById("unit3Button");
	var unit4Button = document.getElementById("unit4Button");
	var unit1ButtonImage = document.getElementById("unit1ButtonImage");
	var unit2ButtonImage = document.getElementById("unit2ButtonImage");
	var unit3ButtonImage = document.getElementById("unit3ButtonImage");
	var unit4ButtonImage = document.getElementById("unit4ButtonImage");
	var progressBarProgress = document.getElementById("progressBarProgress");
	
	
	var Img = {};
	Img.background = new Image();
	Img.background.src = '/client/img/stars.jpg';
	Img.units = new Image();
	Img.units.src = '/client/img/units.png';
	Img.buildings = new Image();
	Img.buildings.src = '/client/img/buildings.png';
	Img.neutralCursor = new Image();
	Img.neutralCursor.src = '/client/img/neutral.png';
	Img.moveCursor = new Image();
	Img.moveCursor.src = '/client/img/move.png';
	Img.captureCursor = new Image();
	Img.captureCursor.src = '/client/img/capture.png';
	Img.attackCursor = new Image();
	Img.attackCursor.src = '/client/img/attack.png';
	var whichCursor = 'neutral';
	
	
	// classes
	
	var Particle = function(x, y, angle, speed, radius, colorR, colorG, colorB, colorA){
		var self = {
			x: x,
			y: y,
			angle: angle,
			speed: speed,
			radius: radius,
			colorR: colorR,
			colorG: colorG,
			colorB: colorB,
			colorA: colorA,
		}
		
		self.drawParticle = function(){
			gameCanvas.fillStyle = "rgba(" + self.colorR + "," + self.colorG + "," + self.colorB + "," + self.colorA + ")";
			gameCanvas.save();
			gameCanvas.beginPath();
			gameCanvas.arc(self.x, self.y, self.radius, 0, Math.PI*2, false);
			gameCanvas.fill();
			gameCanvas.restore();
		}
		
		return self;
	}
	
	
	var Explosion = function(id, type, x, y, lifeSpan, delay){
		var self = {
			id: id,
			type: type,
			x: x,
			y: y,
			lifeSpan: lifeSpan,
			delay: delay,
			particleList: [],
			PARTICLE_COUNT: 0,
			PARTICLE_START_SPEED_1: 0,
			PARTICLE_START_SPEED_2: 0,
			PARTICLE_RADIUS_1: 0,
			PARTICLE_RADIUS_2: 0,
			PARTICLE_COLOR_R_START: 0,
			PARTICLE_COLOR_G_START: 0,
			PARTICLE_COLOR_B_START: 0,
			PARTICLE_COLOR_A_START: 0,
			PARTICLE_SPEED_CHANGE: 0,
			PARTICLE_RADIUS_CHANGE: 0,
			PARTICLE_COLOR_R_CHANGE: 0,
			PARTICLE_COLOR_G_CHANGE: 0,
			PARTICLE_COLOR_B_CHANGE: 0,
			PARTICLE_COLOR_A_CHANGE: 0,
		}
	
		self.init = function(){
			if (self.type === 1) {	// ship explosion
			    self.PARTICLE_COUNT = 25;
			    self.PARTICLE_START_SPEED_1 = 3;
			    self.PARTICLE_START_SPEED_2 = 0;
			    self.PARTICLE_RADIUS_1 = 10;
			    self.PARTICLE_RADIUS_2 = 20;
			    self.PARTICLE_COLOR_R_START = 255;
			    self.PARTICLE_COLOR_G_START = 255;
			    self.PARTICLE_COLOR_B_START = 170;
			    self.PARTICLE_COLOR_A_START = 1;
			    self.PARTICLE_SPEED_CHANGE = 0.83;
			    self.PARTICLE_RADIUS_CHANGE = 0.92;
			    self.PARTICLE_COLOR_R_CHANGE = 0;
			    self.PARTICLE_COLOR_G_CHANGE = -8;
			    self.PARTICLE_COLOR_B_CHANGE = -40;
			    self.PARTICLE_COLOR_A_CHANGE = 0.87;
			} else if (self.type === 2) {
			    self.PARTICLE_COUNT = 1;
			    self.PARTICLE_START_SPEED_1 = 0;
			    self.PARTICLE_START_SPEED_2 = 0;
			    self.PARTICLE_RADIUS_1 = 0;
			    self.PARTICLE_RADIUS_2 = 17;
			    self.PARTICLE_COLOR_R_START = 255;
			    self.PARTICLE_COLOR_G_START = 100;
			    self.PARTICLE_COLOR_B_START = 0;
			    self.PARTICLE_COLOR_A_START = 1;
			    self.PARTICLE_SPEED_CHANGE = 1;
			    self.PARTICLE_RADIUS_CHANGE = 1.1;
			    self.PARTICLE_COLOR_R_CHANGE = 0;
			    self.PARTICLE_COLOR_G_CHANGE = -80;
			    self.PARTICLE_COLOR_B_CHANGE = -0;
			    self.PARTICLE_COLOR_A_CHANGE = 0.75;
			} else if (self.type === 3) { // big missile explosion
				/*
			    self.PARTICLE_COUNT = 30;
			    self.PARTICLE_START_SPEED_1 = 2;
			    self.PARTICLE_START_SPEED_2 = 0;
			    self.PARTICLE_RADIUS_1 = 6;
			    self.PARTICLE_RADIUS_2 = 12;
			    self.PARTICLE_COLOR_R_START = 255;
			    self.PARTICLE_COLOR_G_START = 255;
			    self.PARTICLE_COLOR_B_START = 170;
			    self.PARTICLE_COLOR_A_START = 1;
			    self.PARTICLE_SPEED_CHANGE = 0.83;
			    self.PARTICLE_RADIUS_CHANGE = 0.92;
			    self.PARTICLE_COLOR_R_CHANGE = 0;
			    self.PARTICLE_COLOR_G_CHANGE = -8;
			    self.PARTICLE_COLOR_B_CHANGE = -40;
			    self.PARTICLE_COLOR_A_CHANGE = 0.87;
				*/
				self.PARTICLE_COUNT = 10;
				self.PARTICLE_START_SPEED_1 = 1.2;
			    self.PARTICLE_START_SPEED_2 = 0.1;
			    self.PARTICLE_RADIUS_1 = 3;
			    self.PARTICLE_RADIUS_2 = 10;
			    self.PARTICLE_COLOR_R_START = 255;
			    self.PARTICLE_COLOR_G_START = 255;
			    self.PARTICLE_COLOR_B_START = 170;
			    self.PARTICLE_COLOR_A_START = 1;
			    self.PARTICLE_SPEED_CHANGE = 0.83;
			    self.PARTICLE_RADIUS_CHANGE = 0.92;
			    self.PARTICLE_COLOR_R_CHANGE = 0;
			    self.PARTICLE_COLOR_G_CHANGE = -20;
			    self.PARTICLE_COLOR_B_CHANGE = -40;
			    self.PARTICLE_COLOR_A_CHANGE = 0.87;
			} else if (self.type === 4) { 
			    self.PARTICLE_COUNT = 1;
				self.PARTICLE_START_SPEED_1 = 0;
				self.PARTICLE_START_SPEED_2 = 0;
				self.PARTICLE_RADIUS_1 = 0;
				self.PARTICLE_RADIUS_2 = 7;
				self.PARTICLE_COLOR_R_START = 255;
				self.PARTICLE_COLOR_G_START = 100;
				self.PARTICLE_COLOR_B_START = 0;
				self.PARTICLE_COLOR_A_START = 1;
				self.PARTICLE_SPEED_CHANGE = 1;
				self.PARTICLE_RADIUS_CHANGE = 1.1;
				self.PARTICLE_COLOR_R_CHANGE = 0;
				self.PARTICLE_COLOR_G_CHANGE = -80;
				self.PARTICLE_COLOR_B_CHANGE = -0;
				self.PARTICLE_COLOR_A_CHANGE = 0.8;
			} else if (self.type === 5) { // small missile
			    self.PARTICLE_COUNT = 4;
			    self.PARTICLE_START_SPEED_1 = 0.5;
			    self.PARTICLE_START_SPEED_2 = 0.1;
			    self.PARTICLE_RADIUS_1 = 2;
			    self.PARTICLE_RADIUS_2 = 5;
			    self.PARTICLE_COLOR_R_START = 255;
			    self.PARTICLE_COLOR_G_START = 255;
			    self.PARTICLE_COLOR_B_START = 170;
			    self.PARTICLE_COLOR_A_START = 1;
			    self.PARTICLE_SPEED_CHANGE = 0.83;
			    self.PARTICLE_RADIUS_CHANGE = 0.92;
			    self.PARTICLE_COLOR_R_CHANGE = 0;
			    self.PARTICLE_COLOR_G_CHANGE = -20;
			    self.PARTICLE_COLOR_B_CHANGE = -40;
			    self.PARTICLE_COLOR_A_CHANGE = 0.87;
			} else if (self.type === 6) { 
			    self.PARTICLE_COUNT = 1;
			    self.PARTICLE_START_SPEED_1 = 0;
			    self.PARTICLE_START_SPEED_2 = 0;
			    self.PARTICLE_RADIUS_1 = 0;
			    self.PARTICLE_RADIUS_2 = 10;
			    self.PARTICLE_COLOR_R_START = 255;
			    self.PARTICLE_COLOR_G_START = 100;
			    self.PARTICLE_COLOR_B_START = 0;
				self.PARTICLE_COLOR_A_START = 1;
			    self.PARTICLE_SPEED_CHANGE = 1;
			    self.PARTICLE_RADIUS_CHANGE = 1.05;
			    self.PARTICLE_COLOR_R_CHANGE = 0;
			    self.PARTICLE_COLOR_G_CHANGE = -80;
			    self.PARTICLE_COLOR_B_CHANGE = -0;
			    self.PARTICLE_COLOR_A_CHANGE = 0.8;
			}
			// add start particles
			for (var i = 0; i < self.PARTICLE_COUNT; i++) {
				var particle = Particle(
					self.x,
					self.y,
					Math.floor(Math.random() * 360),
					Math.random() * self.PARTICLE_START_SPEED_1 + self.PARTICLE_START_SPEED_2,
					Math.random() * self.PARTICLE_RADIUS_1 + self.PARTICLE_RADIUS_2,
					self.PARTICLE_COLOR_R_START,
					self.PARTICLE_COLOR_G_START,
					self.PARTICLE_COLOR_B_START,
					self.PARTICLE_COLOR_A_START
				);
				self.particleList.push(particle);
			}
		}
	
		self.drawParticles = function(){
			for (var i = 0; i < self.PARTICLE_COUNT; i++) {
				self.particleList[i].drawParticle();
			}
			self.recalculateValues();
		}
		
		self.recalculateValues = function(){
			self.lifeSpan--;
			for (var i = 0; i < self.PARTICLE_COUNT; i++) {
				var radians = self.particleList[i].angle * Math.PI / 180;
				var speed = self.particleList[i].speed;
				self.particleList[i].x += Math.sin(radians) * speed - Math.cos(radians) * speed;
				self.particleList[i].y += Math.cos(radians) * speed + Math.sin(radians) * speed;
				self.particleList[i].speed *= self.PARTICLE_SPEED_CHANGE;
				self.particleList[i].radius *= self.PARTICLE_RADIUS_CHANGE;
				self.particleList[i].colorR += self.PARTICLE_COLOR_R_CHANGE;
				self.particleList[i].colorG += self.PARTICLE_COLOR_G_CHANGE;
				self.particleList[i].colorB += self.PARTICLE_COLOR_B_CHANGE;
				self.particleList[i].colorA *= self.PARTICLE_COLOR_A_CHANGE;
			}
		}
	
		return self;
	}
	
	
	// login screen
	
	loginButton.onclick = function(){
		if(nameInput.value !== ""){
			loginScreenDiv.style.display = 'none';
			lobbyScreenDiv.style.display = 'block';
			socket.emit('joinedLobby',{name:nameInput.value});
		}
	}
	
	nameInput.onkeyup = function(e){
		if(e.keyCode === 13 && nameInput.value !== ""){
			loginScreenDiv.style.display = 'none';
			lobbyScreenDiv.style.display = 'block';
			socket.emit('joinedLobby',{name:nameInput.value});
		}
	};
	
	// lobby screen
	
	logoutButton.onclick = function(){
		lobbyScreenDiv.style.display = 'none';
		loginScreenDiv.style.display = 'block';
		nameInput.value = "";
		socket.emit('leftLobby');
	}
	
	openRoomButton.onclick = function(){
		lobbyScreenDiv.style.display = 'none';
		roomScreenDiv.style.display = 'block';
		closeTheGameButton.style.display = 'block';
		startGameButton.style.display = 'block';
		startGameButton.disabled = true;
		roomChatDiv.innerHTML = "";
		showRangesCheckbox.disabled = false;
		repairUnitsCheckbox.disabled = false;
		showRangesCheckbox.checked = true;
		repairUnitsCheckbox.checked = true;
		showRanges = true;
		repairUnits = true;
		socket.emit('createNewGame');
	}
	
	showRangesCheckbox.onclick = function(){
		showRanges = showRangesCheckbox.checked;
		repairUnits = repairUnitsCheckbox.checked;
		socket.emit('gameSettings',{gameId: gameId, playerId: selfId, showRanges: showRanges, repairUnits: repairUnits, map: 0});
	}
	
	repairUnitsCheckbox.onclick = function(){
		showRanges = showRangesCheckbox.checked;
		repairUnits = repairUnitsCheckbox.checked;
		socket.emit('gameSettings',{gameId: gameId, playerId: selfId, showRanges: showRanges, repairUnits: repairUnits, map: 0});
	}
	
	lobbyChatInput.onkeyup = function(e){
		if(e.keyCode === 13 && lobbyChatInput.value !== ""){
			socket.emit('lobbyChatMessage',{id:selfId,message:lobbyChatInput.value});
			lobbyChatInput.value = '';
		}
	};
	
	var joinGame = function(id){
		lobbyScreenDiv.style.display = 'none';
		roomScreenDiv.style.display = 'block';
		leaveTheGameButton.style.display = 'block';
		readyGameButton.style.display = 'block';
		roomChatDiv.innerHTML = "";
		readyGameButton.innerHTML = "I'm ready";
		showRangesCheckbox.disabled = true;
		repairUnitsCheckbox.disabled = true;
		//showRangesCheckbox.checked = true;
		//repairUnitsCheckbox.checked = true;
		socket.emit('joinGame',{gameId:id,player2Id:selfId});
	}
	
	// room screen
	
	closeTheGameButton.onclick = function(){
		roomScreenDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';
		closeTheGameButton.style.display = 'none';
		startGameButton.style.display = 'none';
		startGameButton.disabled = true;
		socket.emit('closeRoom',{gameId:gameId});
		gameId = "";
	}
	
	leaveTheGameButton.onclick = function(){
		roomScreenDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';
		leaveTheGameButton.style.display = 'none';
		readyGameButton.style.display = 'none';
		readyGameButton.innerHTML = "I'm ready";
		socket.emit('leaveRoom',{gameId:gameId});
		gameId = "";
	}
	
	roomChatInput.onkeyup = function(e){
		if(e.keyCode === 13 && roomChatInput.value !== ""){
			socket.emit('roomChatMessage',{gameId:gameId, playerId:selfId, message:roomChatInput.value});
			roomChatInput.value = '';
		}
	};
	
	readyGameButton.onclick = function(){
		if(readyGameButton.innerHTML === "I'm ready"){
			readyGameButton.innerHTML = "I'm not ready";
			socket.emit('gameReady',{gameId:gameId,status:true});
		} else {
			readyGameButton.innerHTML = "I'm ready";
			socket.emit('gameReady',{gameId:gameId,status:false});
		}
	}
	
	startGameButton.onclick = function(){
		socket.emit('startGame',{gameId:gameId});
	}
	
	surrenderButton.onclick = function(){
		socket.emit('endGame',{reason:'surrender', gameId:gameId, playerId:selfId});	
	}
	
	endGameMessageButton.onclick = function(){
		gameId = "";
		endGameMessageDiv.style.display = 'none';
		gameDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';	
	}
	
	unit1Button.onclick = function(){
		if(credits >= unit1Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 1,
				credits: 500,
			});
			credits -= 500;
		}
	}
	
	unit2Button.onclick = function(){
		if(credits >= unit2Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 2,
				credits: 250,
			});
			credits -= 250;
		}
	}
	
	unit3Button.onclick = function(){
		if(credits >= unit3Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 3,
				credits: 750,
			});
			credits -= 750;
		}
	}
	
	unit4Button.onclick = function(){
		if(credits >= unit4Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 4,
				credits: 1500,
			});
			credits -= 1500;
		}
	}
	
	
	
	
	
	socket.on('selfId',function(data){
		selfId = data;
	});
	
	socket.on('lobbyPlayersListUpdate',function(data){
		playersListDiv.innerHTML = "";
		for(var i = 0; i < data.length; i++){
			var player = data[i];
			if (player.id === selfId){
				playersListDiv.innerHTML += '<b>' + player.name + '</b><br>';
			} else {
				playersListDiv.innerHTML += player.name + '<br>';
			}
		}
	});
	
	socket.on('lobbyChatMessageToDisplay',function(data){
		lobbyChatDiv.innerHTML += '<div>' + data + '</div>';
		lobbyChatDiv.scrollTop = lobbyChatDiv.scrollHeight;
	});
	
	socket.on('lobbyGamesListUpdate',function(data){
		gamesListDiv.innerHTML = "";
		for(var i = 0; i < data.length; i++){
			var g = data[i];
			if (g.player2Id === ""){
				gamesListDiv.innerHTML += "<button id='" + g.id + "' style='background-color: #D8E4E8; border:0px; color: #336699; margin-left: 3px; margin-bottom: 4px; height: 30px; width: 272px;' onclick='joinGame(" + g.id + ")'>" + g.name + "'s game</button>";
			} else {
				gamesListDiv.innerHTML += "<button id='" + g.id + "' style='background-color: #D8E4E8; border:0px; color: #336699; margin-left: 3px; margin-bottom: 4px; height: 30px; width: 272px;'>" + g.name + "'s game (full)</button>";
			}
		}
	});
	
	socket.on('gamePlayersListUpdate',function(data){
		roomPlayersListDiv.innerHTML = 'Player 1: ' + data.player1.name + '<br>';
		if (data.player2 !== ""){
			roomPlayersListDiv.innerHTML += 'Player 2: ' + data.player2.name + '<br>';
		}
	});
	
	socket.on('gameID',function(data){
		gameId = data.id;
	})
	
	socket.on('kickedFromRoom',function(){
		gameId = "";
		roomScreenDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';
		leaveTheGameButton.style.display = 'none';
		readyGameButton.style.display = 'none';
	});
	
	socket.on('gameSettingsChanged',function(data){
		showRanges = data.showRanges;
		repairUnits = data.repairUnits;
		showRangesCheckbox.checked = data.showRanges;
		repairUnitsCheckbox.checked = data.repairUnits;
		//alert('showRanges: ' + data.showRanges + ' | repairUnits: ' + data.repairUnits);
		//console.log('changed settings received - showRanges: ' + data.showRanges + ' | repairUnits: ' + data.repairUnits);
	});
	
	socket.on('roomChatMessageToDisplay',function(data){
		roomChatDiv.innerHTML += '<div>' + data.message + '</div>';
		roomChatDiv.scrollTop = roomChatDiv.scrollHeight;
	});
	
	socket.on('gameStartButton',function(data){
		if(data.status === true){
			startGameButton.disabled = false;
		} else {
			startGameButton.disabled = true;
		}
	});
	
	socket.on('gameStarted',function(data){
		unit1Button.disabled = false;
		unit2Button.disabled = false;
		unit3Button.disabled = false;
		unit4Button.disabled = false;
		gameDiv.style.display = 'block';
		roomScreenDiv.style.display = 'none';
		leaveTheGameButton.style.display = 'none';
		readyGameButton.style.display = 'none';
		readyGameButton.innerHTML = "I'm ready";
		playersNamesDiv.innerHTML = '<div style="color:#52E365; display:inline;">' + data.player1name + '</div><div style="color:#cccccc; display:inline;">&nbsp;vs&nbsp;</div><div style="color:#E3E152; display:inline;">' + data.player2name + '</div>';
		if(selfId === data.player1Id){
			unit1ButtonImage.src = '/client/img/unit1a.png';
			unit2ButtonImage.src = '/client/img/unit2a.png';
			unit3ButtonImage.src = '/client/img/unit3a.png';
			unit4ButtonImage.src = '/client/img/unit4a.png';
		} else {
			unit1ButtonImage.src = '/client/img/unit1b.png';
			unit2ButtonImage.src = '/client/img/unit2b.png';
			unit3ButtonImage.src = '/client/img/unit3b.png';
			unit4ButtonImage.src = '/client/img/unit4b.png';
		}
		document.getElementById('gameCanvas').focus();
	});
	
	socket.on('gameEnded',function(data){
		endGameMessageDiv.style.display = 'block';
		endGameMessageBoxDiv.innerHTML = data.message;
	});
	
	socket.on('gameUpdate',function(data){
		mines = data.mines;
		turrets = data.turrets;
		if(selfId === data.player1Id){
			myBase = data.player1Base;
			enemyBase = data.player2Base;
			myUnits = data.player1Units;
			enemyUnits = data.player2Units;
		} else {
			myBase = data.player2Base;
			enemyBase = data.player1Base;
			myUnits = data.player2Units;
			enemyUnits = data.player1Units;
		}
	
		var player1Color = '#52E365';
		var player2Color = '#E3E152';
		//gameCanvas.clearRect(0,0,1200,568);
		gameCanvas.drawImage(Img.background,0,0);
		
		if(myBase.hp <= 0){
			unit1Button.disabled = true;
			unit2Button.disabled = true;
			unit3Button.disabled = true;
			unit4Button.disabled = true;
		}
		
		// player 1 base
		if(data.player1Base.hp > 0){
			gameCanvas.save();
			gameCanvas.translate(data.player1Base.x,data.player1Base.y);
			gameCanvas.rotate(data.player1Base.spin * Math.PI/180);
			gameCanvas.drawImage(Img.buildings,0,0,40,40,-20,-20,40,40);
			gameCanvas.restore();
		}
		// player 2 base
		if(data.player2Base.hp > 0){
			gameCanvas.save();
			gameCanvas.translate(data.player2Base.x,data.player2Base.y);
			gameCanvas.rotate(data.player2Base.spin * Math.PI/180);
			gameCanvas.drawImage(Img.buildings,40,0,40,40,-20,-20,40,40);
			gameCanvas.restore();
		}
		
		for (var i in data.mines){
			var mine = data.mines[i];
			gameCanvas.save();
			gameCanvas.translate(mine.x,mine.y);
			gameCanvas.rotate(mine.spin * Math.PI/180);
			if (mine.owner === 0){
				gameCanvas.drawImage(Img.buildings,80,0,30,30,-15,-15,30,30);
			} else if (mine.owner === 1){
				gameCanvas.drawImage(Img.buildings,110,0,30,30,-15,-15,30,30);
			} else if (mine.owner === 2){
				gameCanvas.drawImage(Img.buildings,140,0,30,30,-15,-15,30,30);
			}
			gameCanvas.restore();
			
			var r,g,b,a;
			if(mine.owner === 1){
				gameCanvas.fillStyle = '#52E365';
				r = 82;
				g = 227;
				b = 101;
			} else if(mine.owner === 2){
				gameCanvas.fillStyle = '#E3E152';
				r = 227;
				g = 225;
				b = 82;
			} else {
				gameCanvas.fillStyle = '#cccccc';
				r = 204;
				g = 204;
				b = 204;
			}
			if (mine.countdown > 30 && mine.countdown <= 50){
				var textMoveFactor = (mine.countdown-15)/2;
				var a = 1 - (mine.countdown-30)/20;
				var color = 'rgba(' + r +',' + g + ',' + b + ',' + a + ')';
				gameCanvas.fillStyle = color;
				gameCanvas.fillText("+50", mine.x-10, mine.y-textMoveFactor);
			}
		}
		
		for (var i in data.turrets){
			var turret = data.turrets[i];
			gameCanvas.save();
			gameCanvas.translate(turret.x,turret.y);
			gameCanvas.rotate(turret.spin * Math.PI/180);
			if (turret.owner === 0){
				gameCanvas.drawImage(Img.buildings,170,0,25,25,-12.5,-12.5,25,25);
			} else if (turret.owner === 1){
				gameCanvas.drawImage(Img.buildings,200,0,25,25,-12.5,-12.5,25,25);
			} else if (turret.owner === 2){
				gameCanvas.drawImage(Img.buildings,230,0,25,25,-12.5,-12.5,25,25);
			}
			gameCanvas.restore();
			
			gameCanvas.save();
			gameCanvas.translate(turret.x,turret.y);
			gameCanvas.rotate(turret.gunAngle * Math.PI/180);
			if (turret.owner === 0){
				gameCanvas.drawImage(Img.buildings,260,1,7,22,-3.5,-11,7,22);
			} else if (turret.owner === 1){
				gameCanvas.drawImage(Img.buildings,270,1,7,22,-3.5,-11,7,22);
			} else if (turret.owner === 2){
				gameCanvas.drawImage(Img.buildings,280,1,7,22,-3.5,-11,7,22);
			}
			gameCanvas.restore();
				
			if (showRanges === true &&
				mouseEndX > turret.x-14 &&
				mouseEndX < turret.x+14 &&
				mouseEndY > turret.y-14 &&
				mouseEndY < turret.y+14
			){
				gameCanvas.strokeStyle = 'rgba(255, 0, 0, 0.25)';
				gameCanvas.save();
				gameCanvas.beginPath();
				gameCanvas.arc(turret.x, turret.y, turret.range, 0, Math.PI*2, false);
				gameCanvas.stroke();
				gameCanvas.restore();
			}
		}
		
		gameCanvas.fillStyle = '#52E365';
		for (var i in data.player1Units){
			var unit = data.player1Units[i];
			
			// line to destination
			if (unit.selected === true && selfId === data.player1Id){
				if(unit.activeOrderType === 'move'){
					gameCanvas.fillStyle = 'rgba(0, 162, 232, 0.4)';
					gameCanvas.strokeStyle = 'rgba(0, 162, 232, 0.2)';
				} else if(unit.activeOrderType === 'capture'){
					gameCanvas.fillStyle = 'rgba(255, 242, 0, 0.4)';
					gameCanvas.strokeStyle = 'rgba(255, 242, 0, 0.2)';
				} else if(unit.activeOrderType === 'attack'){
					gameCanvas.fillStyle = 'rgba(255, 0, 0, 0.4)';
					gameCanvas.strokeStyle = 'rgba(255, 0, 0, 0.2)';
				}
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x, unit.y);
				gameCanvas.lineTo(unit.destinationX, unit.destinationY);
				gameCanvas.stroke();
				gameCanvas.fillRect(unit.destinationX-1.5, unit.destinationY-1.5, 3, 3);
			}
			
			gameCanvas.save();
			gameCanvas.translate(unit.x,unit.y);
			gameCanvas.rotate(unit.angle + Math.PI/2);
			if (unit.type === 1){
				if(unit.moving === true){
					gameCanvas.drawImage(Img.units,39,0,3,12,-4,9,3,12);
					gameCanvas.drawImage(Img.units,39,0,3,12,0,9,3,12);
				}
				gameCanvas.drawImage(Img.units,0,0,9,19,-4.5,-9.5,9,19);
			} else if(unit.type === 2) {
				if(unit.moving === true){
					gameCanvas.drawImage(Img.units,39,0,3,12,-3,6.5,3,12);
					gameCanvas.drawImage(Img.units,39,0,3,12,0,6.5,3,12);
				}
				gameCanvas.drawImage(Img.units,10,0,10,14,-5,-7,10,14);
			} else if(unit.type === 3) {
				if(unit.moving === true){
					gameCanvas.drawImage(Img.units,39,0,3,12,-1.5,9.5,3,12);
				}
				gameCanvas.drawImage(Img.units,21,0,7,19,-3.5,-9.5,7,19);
			} else if(unit.type === 4) {
				if(unit.moving === true){
					gameCanvas.drawImage(Img.units,39,0,3,12,-3.5,13.5,3,12);
					gameCanvas.drawImage(Img.units,39,0,3,12,0.5,13.5,3,12);
				}
				gameCanvas.drawImage(Img.units,29,0,9,27,-4.5,-13.5,9,27);
			}
			gameCanvas.restore();
			if (unit.selected === true && selfId === data.player1Id){
				gameCanvas.strokeStyle = "#cccccc";
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x-10, unit.y-7);
				gameCanvas.lineTo(unit.x-10, unit.y-10);
				gameCanvas.lineTo(unit.x-7, unit.y-10);
				gameCanvas.stroke();
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x+10, unit.y-7);
				gameCanvas.lineTo(unit.x+10, unit.y-10);
				gameCanvas.lineTo(unit.x+7, unit.y-10);
				gameCanvas.stroke();
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x-10, unit.y+7);
				gameCanvas.lineTo(unit.x-10, unit.y+10);
				gameCanvas.lineTo(unit.x-7, unit.y+10);
				gameCanvas.stroke();
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x+10, unit.y+7);
				gameCanvas.lineTo(unit.x+10, unit.y+10);
				gameCanvas.lineTo(unit.x+7, unit.y+10);
				gameCanvas.stroke();
				
				if(unit.group !== 0){
					gameCanvas.fillStyle = '#cccccc';
					gameCanvas.font = '8px Verdana';
					gameCanvas.fillText(unit.group, unit.x+11, unit.y-8);
				}
				
				gameCanvas.fillStyle = '#cccccc';
				gameCanvas.fillRect(unit.x-10, unit.y-14, 20, 3);
				gameCanvas.fillStyle = '#0000ff';
				gameCanvas.fillRect(unit.x-10, unit.y-14, 20*unit.hp/unit.hpMax, 3);
				
				if(showRanges === true){
					gameCanvas.strokeStyle = "rgba(82,227,101,0.1)";
					gameCanvas.beginPath();
					gameCanvas.arc(unit.x,unit.y,unit.range,0,2*Math.PI);
					gameCanvas.stroke();
				}
			}
		}
		
		gameCanvas.fillStyle = '#E3E152';
		for (var i in data.player2Units){
			var unit = data.player2Units[i];
			
			// line to destination
			if (unit.selected === true && selfId === data.player2Id){			
				if(unit.activeOrderType === 'move'){
					gameCanvas.fillStyle = 'rgba(0, 162, 232, 0.4)';
					gameCanvas.strokeStyle = 'rgba(0, 162, 232, 0.2)';
				} else if(unit.activeOrderType === 'capture'){
					gameCanvas.fillStyle = 'rgba(255, 242, 0, 0.4)';
					gameCanvas.strokeStyle = 'rgba(255, 242, 0, 0.2)';
				} else if(unit.activeOrderType === 'attack'){
					gameCanvas.fillStyle = 'rgba(255, 0, 0, 0.4)';
					gameCanvas.strokeStyle = 'rgba(255, 0, 0, 0.2)';
				}
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x, unit.y);
				gameCanvas.lineTo(unit.destinationX, unit.destinationY);
				gameCanvas.stroke();
				gameCanvas.fillRect(unit.destinationX-1.5, unit.destinationY-1.5, 3, 3);
			}
			
			gameCanvas.save();
			gameCanvas.translate(unit.x,unit.y);
			gameCanvas.rotate(unit.angle + Math.PI/2);
			if (unit.type === 1){
				if(unit.moving === true){
					gameCanvas.drawImage(Img.units,39,0,3,12,-4,9,3,12);
					gameCanvas.drawImage(Img.units,39,0,3,12,0,9,3,12);
				}
				gameCanvas.drawImage(Img.units,0,28,9,19,-4.5,-9.5,9,19);
			} else if(unit.type === 2) {
				if(unit.moving === true){
					gameCanvas.drawImage(Img.units,39,0,3,12,-3,6.5,3,12);
					gameCanvas.drawImage(Img.units,39,0,3,12,0,6.5,3,12);
				}
				gameCanvas.drawImage(Img.units,10,28,10,14,-5,-7,10,14);
			} else if(unit.type === 3) {
				if(unit.moving === true){
					gameCanvas.drawImage(Img.units,39,0,3,12,-1.5,9.5,3,12);
				}
				gameCanvas.drawImage(Img.units,21,28,7,19,-3.5,-9.5,7,19);
			} else if(unit.type === 4) {
				if(unit.moving === true){
					gameCanvas.drawImage(Img.units,39,0,3,12,-3.5,13.5,3,12);
					gameCanvas.drawImage(Img.units,39,0,3,12,0.5,13.5,3,12);
				}
				gameCanvas.drawImage(Img.units,29,28,9,27,-4.5,-13.5,9,27);
			}
			gameCanvas.restore();
			if (unit.selected === true && selfId === data.player2Id){
				gameCanvas.strokeStyle = "#cccccc";
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x-10, unit.y-7);
				gameCanvas.lineTo(unit.x-10, unit.y-10);
				gameCanvas.lineTo(unit.x-7, unit.y-10);
				gameCanvas.stroke();
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x+10, unit.y-7);
				gameCanvas.lineTo(unit.x+10, unit.y-10);
				gameCanvas.lineTo(unit.x+7, unit.y-10);
				gameCanvas.stroke();
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x-10, unit.y+7);
				gameCanvas.lineTo(unit.x-10, unit.y+10);
				gameCanvas.lineTo(unit.x-7, unit.y+10);
				gameCanvas.stroke();
				gameCanvas.beginPath();
				gameCanvas.moveTo(unit.x+10, unit.y+7);
				gameCanvas.lineTo(unit.x+10, unit.y+10);
				gameCanvas.lineTo(unit.x+7, unit.y+10);
				gameCanvas.stroke();
				
				if(unit.group !== 0){
					gameCanvas.fillStyle = '#cccccc';
					gameCanvas.font = '8px Verdana';
					gameCanvas.fillText(unit.group, unit.x+11, unit.y-8);
				}
				
				gameCanvas.fillStyle = '#cccccc';
				gameCanvas.fillRect(unit.x-10, unit.y-14, 20, 3);
				gameCanvas.fillStyle = '#0000ff';
				gameCanvas.fillRect(unit.x-10, unit.y-14, 20*unit.hp/unit.hpMax, 3);
				
				if(showRanges === true){
					gameCanvas.strokeStyle = "rgba(227,225,82,0.1)";
					gameCanvas.beginPath();
					gameCanvas.arc(unit.x,unit.y,unit.range,0,2*Math.PI);
					gameCanvas.stroke();
				}
			}
		}
		
		isBattleUnitSelected = false;
		isEngineerUnitSelected = false;
		for (var i in myUnits){
			var unit = myUnits[i];
			if (unit.selected === true && unit.type === 1){
				isEngineerUnitSelected = true;
			} else if (unit.selected && unit.type !== 1){
				isBattleUnitSelected = true;
			}
		}
		
		whichCursor = 'neutral';
		if (isBattleUnitSelected || isEngineerUnitSelected){
			whichCursor = 'move';
		}
		
		var mouseXAbs = Math.abs(mouseStartX - mouseEndX);
		var mouseYAbs = Math.abs(mouseStartY - mouseEndY);
		// drawing selection box
		if (isMouseLeftKeyDown == true && mouseStartX !== mouseEndX && mouseStartY !== mouseEndY) {
			gameCanvas.strokeStyle = "#cccccc";
			gameCanvas.strokeRect(topLeftX, topLeftY, bottomRightX-topLeftX, bottomRightY-topLeftY);
		} else if (isMouseRightKeyDown === true && ( mouseXAbs > 20 || mouseYAbs > 20 ) ) {
			// drawing "front line"
			gameCanvas.strokeStyle = 'rgba(0, 162, 232, 0.4)';
			gameCanvas.beginPath();
			gameCanvas.moveTo(mouseStartX, mouseStartY);
			gameCanvas.lineTo(mouseEndX, mouseEndY);
			gameCanvas.stroke();
		} else { 
			// cursor changing and/or hp bar displaying
			for (var i in mines){
				var mine = mines[i];
				if (mouseEndX > mine.x-10 &&
					mouseEndX < mine.x+10 &&
					mouseEndY > mine.y-10 &&
					mouseEndY < mine.y+10
				){
					if(isEngineerUnitSelected){
						whichCursor = 'capture';
					}
				}
			}
			for (var i in turrets){
				var turret = turrets[i];
				if (mouseEndX > turret.x-10 &&
					mouseEndX < turret.x+10 &&
					mouseEndY > turret.y-10 &&
					mouseEndY < turret.y+10
				){
					if(isEngineerUnitSelected){
						whichCursor = 'capture';
					}
				}
			}
			if (mouseEndX > enemyBase.x-20 &&
				mouseEndX < enemyBase.x+20 &&
				mouseEndY > enemyBase.y-20 &&
				mouseEndY < enemyBase.y+20 &&
				enemyBase.hp > 0
			){
				if(isBattleUnitSelected){
					whichCursor = 'attack';
				}
				gameCanvas.fillStyle = '#cccccc';
				gameCanvas.fillRect(enemyBase.x-15, enemyBase.y-22, 30, 4);
				gameCanvas.fillStyle = '#0000ff';
				gameCanvas.fillRect(enemyBase.x-15, enemyBase.y-22, 30*enemyBase.hp/enemyBase.hpMax, 4);
			}
			if (mouseEndX > myBase.x-20 &&
				mouseEndX < myBase.x+20 &&
				mouseEndY > myBase.y-20 &&
				mouseEndY < myBase.y+20 &&
				myBase.hp > 0
			){
				gameCanvas.fillStyle = '#cccccc';
				gameCanvas.fillRect(myBase.x-15, myBase.y-22, 30, 4);
				gameCanvas.fillStyle = '#0000ff';
				gameCanvas.fillRect(myBase.x-15, myBase.y-22, 30*myBase.hp/myBase.hpMax, 4);
				if (showRanges && repairUnits){
					gameCanvas.strokeStyle = 'rgba(255, 255, 255, 0.1)';
					gameCanvas.save();
					gameCanvas.beginPath();
					gameCanvas.arc(myBase.x, myBase.y, 80, Math.PI*2, false);
					gameCanvas.stroke();
					gameCanvas.restore();
				}
			}
			for (var i in enemyUnits){
				var unit = enemyUnits[i];
				if (mouseEndX > unit.x-10 &&
					mouseEndX < unit.x+10 &&
					mouseEndY > unit.y-10 &&
					mouseEndY < unit.y+10
				){
					if(isBattleUnitSelected){
						whichCursor = 'attack';
					}
					gameCanvas.fillStyle = '#cccccc';
					gameCanvas.fillRect(unit.x-10, unit.y-14, 20, 3);
					gameCanvas.fillStyle = '#0000ff';
					gameCanvas.fillRect(unit.x-10, unit.y-14, 20*unit.hp/unit.hpMax, 3);
				}
			}
			for (var i in myUnits){
				var unit = myUnits[i];
				if (mouseEndX > unit.x-10 &&
					mouseEndX < unit.x+10 &&
					mouseEndY > unit.y-10 &&
					mouseEndY < unit.y+10
				){
					gameCanvas.fillStyle = '#cccccc';
					gameCanvas.fillRect(unit.x-10, unit.y-14, 20, 3);
					gameCanvas.fillStyle = '#0000ff';
					gameCanvas.fillRect(unit.x-10, unit.y-14, 20*unit.hp/unit.hpMax, 3);
				}
			}
		}
		
		for (i in data.player1Bullets){
			var bullet = data.player1Bullets[i];
			var bulletLength;
			if (bullet.type === 2){
				gameCanvas.fillStyle = 'rgba(237, 120, 17, 0.7)';
				bulletLength = 4;
			} else if (bullet.type === 3){
				gameCanvas.fillStyle = 'rgba(42, 227, 25, 0.7)';
				bulletLength = 10;
			} else if (bullet.type === 4){
				gameCanvas.fillStyle = 'rgba(222, 250, 42, 0.7)';
				bulletLength = 7;
			} else if (bullet.type === 5){
				gameCanvas.fillStyle = 'rgba(221, 172, 250, 0.7)';
				bulletLength = 8;
			}
			gameCanvas.save();
			gameCanvas.translate(bullet.x,bullet.y);
			gameCanvas.rotate(bullet.angleInRadians);
			gameCanvas.fillRect(-bulletLength/2, 0, bulletLength, 1);
			gameCanvas.restore();
		}
		for (i in data.player2Bullets){
			var bullet = data.player2Bullets[i];
			var bulletLength;
			if (bullet.type === 2){
				gameCanvas.fillStyle = 'rgba(237, 120, 17, 0.7)';
				bulletLength = 4;
			} else if (bullet.type === 3){
				gameCanvas.fillStyle = 'rgba(42, 227, 25, 0.7)';
				bulletLength = 10;
			} else if (bullet.type === 4){
				gameCanvas.fillStyle = 'rgba(222, 250, 42, 0.7)';
				bulletLength = 7;
			} else if (bullet.type === 5){
				gameCanvas.fillStyle = 'rgba(221, 172, 250, 0.7)';
				bulletLength = 8;
			}
			gameCanvas.save();
			gameCanvas.translate(bullet.x,bullet.y);
			gameCanvas.rotate(bullet.angleInRadians);
			gameCanvas.fillRect(-bulletLength/2, 0, bulletLength, 1);
			gameCanvas.restore();
		}
		
		for (var i in data.newExplosions){
			var expl = data.newExplosions[i];
			var id = Math.random();
			var explosion = Explosion(id, expl.type, expl.x, expl.y, expl.lifeSpan, expl.delay);
			explosion.init();
			
			existingExplosions[id] = explosion;
			//console.log('Explosions count: ' + Object.keys(existingExplosions).length);
		}
		
		for (var i in existingExplosions){
			var explosion = existingExplosions[i];
			if (explosion.delay === 0) {
				explosion.drawParticles();
			} else {
				explosion.delay--;
			}
			if (explosion.lifeSpan < 0) {
				delete existingExplosions[explosion.id];
				//console.log('Explosions count: ' + Object.keys(existingExplosions).length);
			}
		}
		
		
		// cursor
		if (whichCursor === 'neutral'){
			document.getElementById("gameCanvas").style.cursor = "url('/client/img/neutral.png') 9 9, auto";
		} else if (whichCursor === 'move'){
			document.getElementById("gameCanvas").style.cursor = "url('/client/img/move.png') 9 9, auto";
		} else if (whichCursor === 'capture'){
			document.getElementById("gameCanvas").style.cursor = "url('/client/img/capture.png') 9 9, auto";
		} else if (whichCursor === 'attack'){
			document.getElementById("gameCanvas").style.cursor = "url('/client/img/attack.png') 9 9, auto";
		}
		
		
		
	});
	
	socket.on('hudUpdate',function(data){
		credits = data.credits;
		creditsDiv.innerHTML = 'Credits: $' + data.credits;
		progressBarProgress.style.width = data.productionProgress;
	});
	

	
	document.getElementById("gameCanvas").onmousedown = function(e){
		mouseStartX = e.pageX - gameDiv.offsetLeft;
		mouseStartY = e.pageY - gameDiv.offsetTop - 32;
		if (e.button === 0){
			isMouseLeftKeyDown = true;
		}
		if (e.button === 2){
			isMouseRightKeyDown = true;
		}
	}
	
	document.getElementById("gameCanvas").onmouseup = function(e){
		var mouseXAbs = Math.abs(mouseStartX - mouseEndX);
		var mouseYAbs = Math.abs(mouseStartY - mouseEndY);
		if (mouseXAbs < 20 && mouseYAbs < 20 && e.button === 0){

			// checking if any single (my) unit clicked
			var selectedUnitId = '';
			for (var i in myUnits){
				var unit = myUnits[i];
				if (mouseEndX > unit.x-10 &&
					mouseEndX < unit.x+10 &&
					mouseEndY > unit.y-10 &&
					mouseEndY < unit.y+10
				){
					selectedUnitId = unit.id;
				}
			}
			// if single unit clicked, send its id to server
			if (selectedUnitId !== ''){
				socket.emit('selectedUnit', {
					gameId: gameId,
					playerId: selfId,
					selectedUnitId: selectedUnitId,
				});
			} else { // if no single unit clicked
			// if any unit selected then send move / capture / attack command for selected group
				if (isBattleUnitSelected || isEngineerUnitSelected){
					var actionType = 'move';
					var objectId = '';
					for (var i in mines){
						var mine = mines[i];
						if (mouseEndX > mine.x-10 &&
							mouseEndX < mine.x+10 &&
							mouseEndY > mine.y-10 &&
							mouseEndY < mine.y+10
						){
							if(isEngineerUnitSelected){
								actionType = 'capture';
								objectId = mine.id;
							}
						}
					}
					for (var i in turrets){
						var turret = turrets[i];
						if (mouseEndX > turret.x-10 &&
							mouseEndX < turret.x+10 &&
							mouseEndY > turret.y-10 &&
							mouseEndY < turret.y+10
						){
							if(isEngineerUnitSelected){
								actionType = 'capture';
								objectId = turret.id;
							}
						}
					}
					if (mouseEndX > enemyBase.x-20 &&
						mouseEndX < enemyBase.x+20 &&
						mouseEndY > enemyBase.y-20 &&
						mouseEndY < enemyBase.y+20
					){
						if(isBattleUnitSelected){
							actionType = 'attackBase';
							objectId = 'base';
						}
					}
					for (var i in enemyUnits){
						var unit = enemyUnits[i];
						if (mouseEndX > unit.x-10 &&
							mouseEndX < unit.x+10 &&
							mouseEndY > unit.y-10 &&
							mouseEndY < unit.y+10
						){
							if(isBattleUnitSelected){
								actionType = 'attackUnit';
								objectId = unit.id;
							}
						}
					}
					
					socket.emit('orderForUnits', {
						gameId: gameId,
						playerId: selfId,
						actionType: actionType,
						objectId: objectId,
						destinationX: mouseEndX,
						destinationY: mouseEndY,
					});
				} 
			}
		} else if(e.button === 0) { // or selected area wasn't a "click", send selection box to server
			socket.emit('selectionBox', {
				gameId: gameId,
				playerId: selfId,
				topLeftX: topLeftX, 
				topLeftY: topLeftY, 
				bottomRightX: bottomRightX, 
				bottomRightY: bottomRightY,
			});
		}

		if (mouseXAbs < 20 && mouseYAbs < 20 && e.button === 2){
			socket.emit('rightClick',{gameId:gameId, playerId: selfId});
		} else if (e.button === 2){
			var numberOfSelectedUnits = 0;
			for (var i in myUnits){
				var unit = myUnits[i];
				if (unit.selected){
					numberOfSelectedUnits++;
				}
			}
			
			var lineLength = Math.sqrt( (mouseStartX-mouseEndX)*(mouseStartX-mouseEndX) + (mouseStartY-mouseEndY)*(mouseStartY-mouseEndY) );
			var lineAngleInRadians = Math.atan2(mouseEndY-mouseStartY, mouseEndX-mouseStartX);
			var howManyUnitsInSingleLine = Math.floor(lineLength / 15) + 1;
			var howManyLines = Math.ceil(numberOfSelectedUnits / howManyUnitsInSingleLine);
			var howManyFullLines = Math.floor(numberOfSelectedUnits / howManyUnitsInSingleLine);
			
			var destinations = [];
			
			//console.log('sending line - from: ' + mouseStartX + ', ' + mouseStartY + ' to: ' + mouseEndX + ', ' + mouseEndY);
			//console.log('selected units: ' + numberOfSelectedUnits);
			//console.log('line length: ' + lineLength);
			//console.log('line angle: ' + lineAngleInRadians / Math.PI * 180);
			//console.log('there can be ' + howManyUnitsInSingleLine + ' unit in single line, so we need ' + howManyLines + ' lines.');
			
			for (var n = 0; n < howManyLines; n++){
				if (n < howManyFullLines){
					var margin = ( lineLength - 15*(howManyUnitsInSingleLine-1) )/2;
					for (var i = 0; i < howManyUnitsInSingleLine; i++){
						var x = ( mouseStartX + (margin+i*15) * Math.cos(lineAngleInRadians) - (n*15) * Math.sin(lineAngleInRadians) ).toFixed(1);
						var y = ( mouseStartY + (margin+i*15) * Math.sin(lineAngleInRadians) + (n*15) * Math.cos(lineAngleInRadians) ).toFixed(1);
						destinations.push({
							x: x,
							y: y,
						});
						//console.log('unit in line ' + (n+1) + ' on position: ' + x + ', ' + y);
					}
				} else {
					var unitsLeft = numberOfSelectedUnits - howManyFullLines*howManyUnitsInSingleLine;
					var margin = ( lineLength - 15*(unitsLeft-1) )/2;
					for (var i = 0; i < unitsLeft; i++){
						var x = ( mouseStartX + (margin+i*15) * Math.cos(lineAngleInRadians) - (n*15) * Math.sin(lineAngleInRadians) ).toFixed(1);
						var y = ( mouseStartY + (margin+i*15) * Math.sin(lineAngleInRadians) + (n*15) * Math.cos(lineAngleInRadians) ).toFixed(1);
						destinations.push({
							x: x,
							y: y,
						});
						//console.log('unit in line ' + (n+1) + ' on position: ' + x + ', ' + y);
					}
				}
			}
		
			socket.emit('formationLine',{gameId: gameId, playerId: selfId, destinations: destinations});
			
			
		}
		
		isMouseLeftKeyDown = false;
		isMouseRightKeyDown = false;
		topLeftX = 0;
		topLeftY = 0;
		bottomRightX = 0;
		bottomRightY = 0;
	}
	
	document.getElementById("gameCanvas").onmousemove = function(e){
		mouseEndX = e.pageX - gameDiv.offsetLeft;
		mouseEndY = e.pageY - gameDiv.offsetTop - 32;
		
		if (isMouseLeftKeyDown === true){
			topLeftX = 0;
			topLeftY = 0;
			bottomRightX = 0;
			bottomRightY = 0;
			
			if (mouseEndX <= mouseStartX) {
				topLeftX = mouseEndX;
				bottomRightX = mouseStartX;
			}
			else {
				topLeftX = mouseStartX;
				bottomRightX = mouseEndX;
			}
			if (mouseEndY <= mouseStartY) {
				topLeftY = mouseEndY;
				bottomRightY = mouseStartY;
			}
			else {
				topLeftY = mouseStartY;
				bottomRightY = mouseEndY;
			}
		}
	}
	
	document.getElementById("gameCanvas").oncontextmenu = function(e){
		e.preventDefault();
	}
	
	document.getElementById("gameCanvas").onkeydown = function(e){
		//e.preventDefault();
		if (e.keyCode === 49){
			keys['_1'] = true;
		}
		if (e.keyCode === 50){
			keys['_2'] = true;
		}
		if (e.keyCode === 51){
			keys['_3'] = true;
		}
		if (e.keyCode === 52){
			keys['_4'] = true;
		}
		if (e.keyCode === 16){
			keys['shift'] = true;
		}
		if (e.keyCode === 81){
			keys['q'] = true;
		}
		if (e.keyCode === 87){
			keys['w'] = true;
		}
		if (e.keyCode === 69){
			keys['e'] = true;
		}
		if (e.keyCode === 82){
			keys['r'] = true;
		}
		
		// set group
		if(isEngineerUnitSelected || isBattleUnitSelected){ // set group
			if (keys['shift'] && (keys['_1'] || keys['_2'] || keys['_3'] || keys['_4']) ){
				var groupNumber;
				if (keys['_1']) {
					groupNumber = 1;
				} else if (keys['_2']) {
					groupNumber = 2;
				} else if (keys['_3']) {
					groupNumber = 3;
				} else if (keys['_4']) {
					groupNumber = 4;
				}
				socket.emit('groupSet',{gameId: gameId, playerId: selfId, groupNumber: groupNumber});
			}
		}
		
		// call group
		if (keys['_1'] || keys['_2'] || keys['_3'] || keys['_4']){
			var groupNumber;
			if (keys['_1']) {
				groupNumber = 1;
			} else if (keys['_2']) {
				groupNumber = 2;
			} else if (keys['_3']) {
				groupNumber = 3;
			} else if (keys['_4']) {
				groupNumber = 4;
			}
			socket.emit('groupCalled',{gameId: gameId, playerId: selfId, groupNumber: groupNumber});
		}
		
		// try to build unit 1
		if(keys['q'] && credits >= unit1Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 1,
				credits: 500,
			});
			credits -= 500;
		}
		
		// try to build unit 2
		if(keys['w'] && credits >= unit2Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 2,
				credits: 250,
			});
			credits -= 250;
		}
		
		// try to build unit 3
		if(keys['e'] && credits >= unit3Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 3,
				credits: 750,
			});
			credits -= 750;
		}
		
		// try to build unit 4
		if(keys['r'] && credits >= unit4Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 4,
				credits: 1500,
			});
			credits -= 1500;
		}
	}
	
	document.getElementById("gameCanvas").onkeyup = function(e){
		if (e.keyCode === 49){
			keys['_1'] = false;
		}
		if (e.keyCode === 50){
			keys['_2'] = false;
		}
		if (e.keyCode === 51){
			keys['_3'] = false;
		}
		if (e.keyCode === 52){
			keys['_4'] = false;
		}
		if (e.keyCode === 16){
			keys['shift'] = false;
		}
		if (e.keyCode === 81){
			keys['q'] = false;
		}
		if (e.keyCode === 87){
			keys['w'] = false;
		}
		if (e.keyCode === 69){
			keys['e'] = false;
		}
		if (e.keyCode === 82){
			keys['r'] = false;
		}
	}
	
	
</script>