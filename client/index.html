<head>
	<title>simpleRTS</title>
	<link rel="stylesheet" type="text/css" href="client/style.css">
</head>

<div id="loginScreenDiv">
	<div id="gameNameDiv">
		simpleRTS
	</div>
	<div id="enterNameDiv">
		Your name
		<input id="nameInput" type="text" placeholder="Enter your nickname" maxlength="18"></input><br>
		<button id="loginButton">Login</button>
	</div>
</div>

<div id="lobbyScreenDiv">
	<div id="lobbyHeaderDiv">
		simpleRTS
		<button id="logoutButton">Logout</button>
	</div>
	<div id="gamesListContainerDiv">
		<b>Open games (click to join)</b>
		<div id="gamesListDiv"></div>
		<button id="openRoomButton">Create new game</button>
	</div>
	<div id="lobbyChatContainerDiv">
		<b>&nbsp;Chat</b>
		<div id="lobbyChatDiv"></div>
		<input id="lobbyChatInput" type="text" placeholder="Enter your message"></input>
	</div>
	<div id="playersListContainerDiv">
		<b>All players</b>
		<div id="playersListDiv"></div>
	</div>
</div>

<div id="roomScreenDiv">
	<div id="roomHeaderDiv">
		simpleRTS
		<button id="closeTheGameButton">Close the game</button>
		<button id="leaveTheGameButton">Leave the game</button>
	</div>
	<div id="gameOptionsContainerDiv">
		<b>Game options</b>
		<button id="startGameButton" disabled>Start the game</button>
		<button id="readyGameButton">I'm ready</button>
	</div>
	<div id="roomChatContainerDiv">
		<b>&nbsp;Chat</b>
		<div id="roomChatDiv"></div>
		<input id="roomChatInput" type="text" placeholder="Enter your message"></input>
	</div>
	<div id="roomPlayersListContainerDiv">
		<b>Players</b>
		<div id="roomPlayersListDiv"></div>
	</div>
</div>

<div id="gameDiv">
	<div id="gameTopBarDiv">
		<div id="creditsDiv"></div>
		<div id="unitButtonsDiv">
			<button id="unit1Button" class="unitButton"><img class="unitImage" src="client/img/unit1.png"><span class="unitLabel">&nbsp;$500</span></button>
			<button id="unit2Button" class="unitButton"><img class="unitImage" src="client/img/unit1.png"><span class="unitLabel">&nbsp;$250</span></button>
			<button id="unit3Button" class="unitButton"><img class="unitImage" src="client/img/unit1.png"><span class="unitLabel">&nbsp;$750</span></button>
			<button id="unit4Button" class="unitButton"><img class="unitImage" src="client/img/unit1.png"><span class="unitLabel">&nbsp;$1500</span></button>
		</div>
		<div id="progressBarDiv">
			<div id="progressBarBackground"></div>
			<div id="progressBarProgress"></div>
		</div>
		
		<div id="playersNamesDiv"></div>
		<button id="surrenderButton">Surrender</button>
	</div>
	
	<canvas id="gameCanvas" width="1200" height="568"></canvas>
	<div id="endGameMessageDiv">
		<div id="endGameMessageBoxDiv"></div>
		<button id="endGameMessageButton">Exit to lobby</button>
	</div>
	
</div>




<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>
	var socket = io();
	var selfId = "";
	var gameId = "";
	var credits = "";
	var unit1Cost = 500;
	var unit2Cost = 250;
	var unit3Cost = 750;
	var unit4Cost = 1500;
	window.onbeforeunload = function() {
		socket.disconnect(); 
	}
	
	var loginScreenDiv = document.getElementById("loginScreenDiv");
	var nameInput = document.getElementById("nameInput");
	var loginButton = document.getElementById("loginButton");
	
	var lobbyScreenDiv = document.getElementById("lobbyScreenDiv");
	var openRoomButton = document.getElementById("openRoomButton");
	var logoutButton = document.getElementById("logoutButton");
	var lobbyChatDiv = document.getElementById("lobbyChatDiv");
	var lobbyChatInput = document.getElementById("lobbyChatInput");
	var playersListDiv = document.getElementById("playersListDiv");
	
	var roomScreenDiv = document.getElementById("roomScreenDiv");
	var closeTheGameButton = document.getElementById("closeTheGameButton");
	var leaveTheGameButton = document.getElementById("leaveTheGameButton");
	var roomPlayersListDiv = document.getElementById("roomPlayersListDiv");
	var roomChatDiv = document.getElementById("roomChatDiv");
	var roomChatInput = document.getElementById("roomChatInput");
	var startGameButton = document.getElementById("startGameButton");
	var readyGameButton = document.getElementById("readyGameButton");
	
	var gameDiv = document.getElementById("gameDiv");
	var creditsDiv = document.getElementById("creditsDiv");
	var playersNamesDiv = document.getElementById("playersNamesDiv");
	var surrenderButton = document.getElementById("surrenderButton");
	
	var endGameMessageDiv = document.getElementById("endGameMessageDiv");
	var endGameMessageBoxDiv = document.getElementById("endGameMessageBoxDiv");
	var endGameMessageButton = document.getElementById("endGameMessageButton");
	var gameCanvas = document.getElementById("gameCanvas").getContext("2d");
	var unit1Button = document.getElementById("unit1Button");
	var unit2Button = document.getElementById("unit2Button");
	var unit3Button = document.getElementById("unit3Button");
	var unit4Button = document.getElementById("unit4Button");
	var progressBarProgress = document.getElementById("progressBarProgress");
	
	
	var Img = {};
	Img.units = new Image();
	Img.units.src = '/client/img/units.png';
	Img.buildings = new Image();
	Img.buildings.src = '/client/img/buildings.png';
	
	
	// login screen
	
	loginButton.onclick = function(){
		if(nameInput.value !== ""){
			loginScreenDiv.style.display = 'none';
			lobbyScreenDiv.style.display = 'block';
			socket.emit('joinedLobby',{name:nameInput.value});
		}
	}
	
	nameInput.onkeyup = function(e){
		if(e.keyCode === 13 && nameInput.value !== ""){
			loginScreenDiv.style.display = 'none';
			lobbyScreenDiv.style.display = 'block';
			socket.emit('joinedLobby',{name:nameInput.value});
		}
	};
	
	// lobby screen
	
	logoutButton.onclick = function(){
		lobbyScreenDiv.style.display = 'none';
		loginScreenDiv.style.display = 'block';
		nameInput.value = "";
		socket.emit('leftLobby');
	}
	
	openRoomButton.onclick = function(){
		lobbyScreenDiv.style.display = 'none';
		roomScreenDiv.style.display = 'block';
		closeTheGameButton.style.display = 'block';
		startGameButton.style.display = 'block';
		startGameButton.disabled = true;
		roomChatDiv.innerHTML = "";
		socket.emit('createNewGame');
	}
	
	lobbyChatInput.onkeyup = function(e){
		if(e.keyCode === 13 && lobbyChatInput.value !== ""){
			socket.emit('lobbyChatMessage',{id:selfId,message:lobbyChatInput.value});
			lobbyChatInput.value = '';
		}
	};
	
	var joinGame = function(gameId){
		lobbyScreenDiv.style.display = 'none';
		roomScreenDiv.style.display = 'block';
		leaveTheGameButton.style.display = 'block';
		readyGameButton.style.display = 'block';
		roomChatDiv.innerHTML = "";
		readyGameButton.innerHTML = "I'm ready";
		socket.emit('joinGame',{gameId:gameId,player2Id:selfId});
	}
	
	// room screen
	
	closeTheGameButton.onclick = function(){
		roomScreenDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';
		closeTheGameButton.style.display = 'none';
		startGameButton.style.display = 'none';
		startGameButton.disabled = true;
		socket.emit('closeRoom',{gameId:gameId});
		gameId = "";
	}
	
	leaveTheGameButton.onclick = function(){
		roomScreenDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';
		leaveTheGameButton.style.display = 'none';
		readyGameButton.style.display = 'none';
		readyGameButton.innerHTML = "I'm ready";
		socket.emit('leaveRoom',{gameId:gameId});
		gameId = "";
	}
	
	roomChatInput.onkeyup = function(e){
		if(e.keyCode === 13 && roomChatInput.value !== ""){
			socket.emit('roomChatMessage',{gameId:gameId, playerId:selfId, message:roomChatInput.value});
			roomChatInput.value = '';
		}
	};
	
	readyGameButton.onclick = function(){
		if(readyGameButton.innerHTML === "I'm ready"){
			readyGameButton.innerHTML = "I'm not ready";
			socket.emit('gameReady',{gameId:gameId,status:true});
		} else {
			readyGameButton.innerHTML = "I'm ready";
			socket.emit('gameReady',{gameId:gameId,status:false});
		}
	}
	
	startGameButton.onclick = function(){
		socket.emit('startGame',{gameId:gameId});
	}
	
	surrenderButton.onclick = function(){
		socket.emit('endGame',{reason:'surrender', gameId:gameId, playerId:selfId});	
	}
	
	endGameMessageButton.onclick = function(){
		gameId = "";
		endGameMessageDiv.style.display = 'none';
		gameDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';	
	}
	
	unit1Button.onclick = function(){
		if(credits >= unit1Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 1,
				credits: 500,
			});
			credits -= 500;
		}
	}
	
	unit2Button.onclick = function(){
		if(credits >= unit2Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 2,
				credits: 250,
			});
			credits -= 250;
		}
	}
	
	unit3Button.onclick = function(){
		if(credits >= unit3Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 3,
				credits: 750,
			});
			credits -= 750;
		}
	}
	
	unit4Button.onclick = function(){
		if(credits >= unit4Cost && progressBarProgress.style.width === '0px'){
			socket.emit('procudeUnit',{
				gameId: gameId,
				playerId: selfId,
				type: 4,
				credits: 1500,
			});
			credits -= 1500;
		}
	}
	
	
	
	
	
	socket.on('selfId',function(data){
		selfId = data;
	});
	
	socket.on('lobbyPlayersListUpdate',function(data){
		playersListDiv.innerHTML = "";
		for(var i = 0; i < data.length; i++){
			var player = data[i];
			if (player.id === selfId){
				playersListDiv.innerHTML += '<b>' + player.name + '</b><br>';
			} else {
				playersListDiv.innerHTML += player.name + '<br>';
			}
		}
	});
	
	socket.on('lobbyChatMessageToDisplay',function(data){
		lobbyChatDiv.innerHTML += '<div>' + data + '</div>';
		lobbyChatDiv.scrollTop = lobbyChatDiv.scrollHeight;
	});
	
	socket.on('lobbyGamesListUpdate',function(data){
		gamesListDiv.innerHTML = "";
		for(var i = 0; i < data.length; i++){
			var g = data[i];
			if (g.player2Id === ""){
				gamesListDiv.innerHTML += "<button id='" + g.id + "' style='background-color: #D8E4E8; border:0px; color: #336699; margin-left: 3px; margin-bottom: 4px; height: 30px; width: 272px;' onclick='joinGame(" + g.id + ")'>" + g.name + "'s game</button>";
			} else {
				gamesListDiv.innerHTML += "<button id='" + g.id + "' style='background-color: #D8E4E8; border:0px; color: #336699; margin-left: 3px; margin-bottom: 4px; height: 30px; width: 272px;'>" + g.name + "'s game (full)</button>";
			}
		}
	});
	
	socket.on('gamePlayersListUpdate',function(data){
		roomPlayersListDiv.innerHTML = 'Player 1: ' + data.player1.name + '<br>';
		if (data.player2 !== ""){
			roomPlayersListDiv.innerHTML += 'Player 2: ' + data.player2.name + '<br>';
		}
	});
	
	socket.on('gameID',function(data){
		gameId = data.id;
	})
	
	socket.on('kickedFromRoom',function(){
		gameId = "";
		roomScreenDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';
		leaveTheGameButton.style.display = 'none';
		readyGameButton.style.display = 'none';
	});
	
	socket.on('roomChatMessageToDisplay',function(data){
		roomChatDiv.innerHTML += '<div>' + data.message + '</div>';
		roomChatDiv.scrollTop = roomChatDiv.scrollHeight;
	});
	
	socket.on('gameStartButton',function(data){
		if(data.status === true){
			startGameButton.disabled = false;
		} else {
			startGameButton.disabled = true;
		}
	});
	
	socket.on('gameStarted',function(data){
		gameDiv.style.display = 'block';
		roomScreenDiv.style.display = 'none';
		leaveTheGameButton.style.display = 'none';
		readyGameButton.style.display = 'none';
		readyGameButton.innerHTML = "I'm ready";
		playersNamesDiv.innerHTML = '<div style="color:#52E365; display:inline;">' + data.player1name + '</div><div style="color:#cccccc; display:inline;">&nbsp;vs&nbsp;</div><div style="color:#E3E152; display:inline;">' + data.player2name + '</div>';
	});
	
	socket.on('gameEnded',function(data){
		endGameMessageDiv.style.display = 'block';
		endGameMessageBoxDiv.innerHTML = data.message;
	});
	
	socket.on('gameUpdate',function(data){
		var player1Color = '#52E365';
		var player2Color = '#E3E152';
		gameCanvas.clearRect(0,0,1200,560);
		
		// player 1 base
		gameCanvas.save();
		gameCanvas.translate(data.player1Base.x,data.player1Base.y);
		gameCanvas.rotate(data.player1Base.spin * Math.PI/180);
		gameCanvas.drawImage(Img.buildings,0,0,32,32,-16,-16,32,32);
		gameCanvas.restore();
		// player 2 base
		gameCanvas.save();
		gameCanvas.translate(data.player2Base.x,data.player2Base.y);
		gameCanvas.rotate(data.player2Base.spin * Math.PI/180);
		gameCanvas.drawImage(Img.buildings,32,0,32,32,-16,-16,32,32);
		gameCanvas.restore();
		
		gameCanvas.fillStyle = '#cccccc';
		for (var i in data.mines){
			var mine = data.mines[i];
			gameCanvas.save();
			gameCanvas.translate(mine.x,mine.y);
			gameCanvas.rotate(mine.spin * Math.PI/180);
			gameCanvas.drawImage(Img.buildings,65,1,30,30,-15,-15,30,30);
			gameCanvas.restore();
			
			gameCanvas.beginPath();
			gameCanvas.arc(mine.x,mine.y,6,0,2*Math.PI);
			gameCanvas.fill();
		}
		
		gameCanvas.fillStyle = '#52E365';
		for (var i in data.player1Units){
			var unit = data.player1Units[i];
			gameCanvas.save();
			gameCanvas.translate(unit.x,unit.y);
			gameCanvas.rotate(unit.angle + Math.PI/2);
			if (unit.type === 1){
				gameCanvas.drawImage(Img.units,1,15,5,9,-3,-5,5,9);
			} else if(unit.type === 2) {
				gameCanvas.drawImage(Img.units,8,14,8,10,-5,-5,8,10);
			} else if(unit.type === 3) {
				gameCanvas.drawImage(Img.units,18,8,9,16,-5,-8,9,16);
			} else if(unit.type === 4) {
				gameCanvas.drawImage(Img.units,29,1,10,23,-5,-12,10,23);
			}
			gameCanvas.restore();
		}
		
		gameCanvas.fillStyle = '#E3E152';
		for (var i in data.player2Units){
			var unit = data.player2Units[i];
			gameCanvas.save();
			gameCanvas.translate(unit.x,unit.y);
			gameCanvas.rotate(unit.angle + Math.PI/2);
			if (unit.type === 1){
				gameCanvas.drawImage(Img.units,1,40,5,9,-3,-5,5,9);
			} else if(unit.type === 2) {
				gameCanvas.drawImage(Img.units,8,39,8,10,-5,-5,8,10);
			} else if(unit.type === 3) {
				gameCanvas.drawImage(Img.units,18,33,9,16,-5,-8,9,16);
			} else if(unit.type === 4) {
				gameCanvas.drawImage(Img.units,29,26,10,23,-5,-12,10,23);
			}
			gameCanvas.restore();
		}
		
		
		
		
	});
	
	socket.on('hudUpdate',function(data){
		credits = data.credits;
		creditsDiv.innerHTML = 'Credits: $' + data.credits;
		progressBarProgress.style.width = data.productionProgress;
	});
	

	
	
	
</script>