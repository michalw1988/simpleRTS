<head>
	<title>simpleRTS</title>
	<link rel="stylesheet" type="text/css" href="client/style.css">
</head>

<div id="loginScreenDiv">
	<div id="gameNameDiv">
		simpleRTS
	</div>
	<div id="enterNameDiv">
		Your name
		<input id="nameInput" type="text" placeholder="Enter your nickname" maxlength="18"></input><br>
		<button id="loginButton">Login</button>
	</div>
</div>

<div id="lobbyScreenDiv">
	<div id="lobbyHeaderDiv">
		simpleRTS
		<button id="logoutButton">Logout</button>
	</div>
	<div id="gamesListContainerDiv">
		<b>Open games (click to join)</b>
		<div id="gamesListDiv"></div>
		<button id="openRoomButton">Create new game</button>
	</div>
	<div id="lobbyChatContainerDiv">
		<b>&nbsp;Chat</b>
		<div id="lobbyChatDiv"></div>
		<input id="lobbyChatInput" type="text" placeholder="Enter your message"></input>
	</div>
	<div id="playersListContainerDiv">
		<b>All players</b>
		<div id="playersListDiv"></div>
	</div>
</div>

<div id="roomScreenDiv">
	<div id="roomHeaderDiv">
		simpleRTS
		<button id="closeTheGameButton">Close the game</button>
		<button id="leaveTheGameButton">Leave the game</button>
	</div>
	<div id="gameOptionsContainerDiv">
		<b>Game options</b>
		<button id="startGameButton" disabled>Start the game</button>
		<button id="readyGameButton">I'm ready</button>
	</div>
	<div id="roomChatContainerDiv">
		<b>&nbsp;Chat</b>
		<div id="roomChatDiv"></div>
		<input id="roomChatInput" type="text" placeholder="Enter your message"></input>
	</div>
	<div id="roomPlayersListContainerDiv">
		<b>Players</b>
		<div id="roomPlayersListDiv"></div>
	</div>
</div>

<div id="gameDiv">
	<div id="gameTopBarDiv">
		<div id="creditsDiv">Credits: xxx</div>
		
		<div id="playersNamesDiv"></div>
		
		<button id="surrenderButton">Surrender</button>
	</div>
	<canvas id="gameCanvas"></canvas>
	
</div>

<canvas id="ctx" width="500" height="500" style="border:1px solid #000000; display:none;"></canvas>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>
	var socket = io();
	var selfId = null;
	var gameId = null;
	window.onbeforeunload = function() {
		socket.disconnect(); 
	}
	
	var ctx = document.getElementById("ctx").getContext("2d");
	var loginScreenDiv = document.getElementById("loginScreenDiv");
	var nameInput = document.getElementById("nameInput");
	var loginButton = document.getElementById("loginButton");
	
	var lobbyScreenDiv = document.getElementById("lobbyScreenDiv");
	var openRoomButton = document.getElementById("openRoomButton");
	var logoutButton = document.getElementById("logoutButton");
	var lobbyChatDiv = document.getElementById("lobbyChatDiv");
	var lobbyChatInput = document.getElementById("lobbyChatInput");
	var playersListDiv = document.getElementById("playersListDiv");
	
	var roomScreenDiv = document.getElementById("roomScreenDiv");
	var closeTheGameButton = document.getElementById("closeTheGameButton");
	var leaveTheGameButton = document.getElementById("leaveTheGameButton");
	var roomPlayersListDiv = document.getElementById("roomPlayersListDiv");
	var roomChatDiv = document.getElementById("roomChatDiv");
	var roomChatInput = document.getElementById("roomChatInput");
	var startGameButton = document.getElementById("startGameButton");
	var readyGameButton = document.getElementById("readyGameButton");
	
	var gameDiv = document.getElementById("gameDiv");
	var playersNamesDiv = document.getElementById("playersNamesDiv");
	var surrenderButton = document.getElementById("surrenderButton");
	
	
	
	// login screen
	
	loginButton.onclick = function(){
		if(nameInput.value !== ""){
			loginScreenDiv.style.display = 'none';
			lobbyScreenDiv.style.display = 'block';
			socket.emit('joinedLobby',{name:nameInput.value});
		}
	}
	
	nameInput.onkeyup = function(e){
		if(e.keyCode === 13 && nameInput.value !== ""){
			loginScreenDiv.style.display = 'none';
			lobbyScreenDiv.style.display = 'block';
			socket.emit('joinedLobby',{name:nameInput.value});
		}
	};
	
	// lobby screen
	
	logoutButton.onclick = function(){
		lobbyScreenDiv.style.display = 'none';
		loginScreenDiv.style.display = 'block';
		nameInput.value = "";
		socket.emit('leftLobby');
	}
	
	openRoomButton.onclick = function(){
		lobbyScreenDiv.style.display = 'none';
		roomScreenDiv.style.display = 'block';
		closeTheGameButton.style.display = 'block';
		startGameButton.style.display = 'block';
		startGameButton.disabled = true;
		roomChatDiv.innerHTML = "";
		socket.emit('createNewGame');
	}
	
	lobbyChatInput.onkeyup = function(e){
		if(e.keyCode === 13 && lobbyChatInput.value !== ""){
			socket.emit('lobbyChatMessage',{id:selfId,message:lobbyChatInput.value});
			lobbyChatInput.value = '';
		}
	};
	
	var joinGame = function(gameId){
		lobbyScreenDiv.style.display = 'none';
		roomScreenDiv.style.display = 'block';
		leaveTheGameButton.style.display = 'block';
		readyGameButton.style.display = 'block';
		roomChatDiv.innerHTML = "";
		readyGameButton.innerHTML = "I'm ready";
		socket.emit('joinGame',{gameId:gameId,player2Id:selfId});
	}
	
	// room screen
	
	closeTheGameButton.onclick = function(){
		roomScreenDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';
		closeTheGameButton.style.display = 'none';
		startGameButton.style.display = 'none';
		startGameButton.disabled = true;
		socket.emit('closeRoom',{gameId:gameId});
		gameId = "";
	}
	
	leaveTheGameButton.onclick = function(){
		roomScreenDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';
		leaveTheGameButton.style.display = 'none';
		readyGameButton.style.display = 'none';
		readyGameButton.innerHTML = "I'm ready";
		socket.emit('leaveRoom',{gameId:gameId});
		gameId = "";
	}
	
	roomChatInput.onkeyup = function(e){
		if(e.keyCode === 13 && roomChatInput.value !== ""){
			socket.emit('roomChatMessage',{gameId:gameId, playerId:selfId, message:roomChatInput.value});
			roomChatInput.value = '';
		}
	};
	
	readyGameButton.onclick = function(){
		if(readyGameButton.innerHTML === "I'm ready"){
			readyGameButton.innerHTML = "I'm not ready";
			socket.emit('gameReady',{gameId:gameId,status:true});
		} else {
			readyGameButton.innerHTML = "I'm ready";
			socket.emit('gameReady',{gameId:gameId,status:false});
		}
	}
	
	startGameButton.onclick = function(){
		socket.emit('startGame',{gameId:gameId});
	}
	
	surrenderButton.onclick = function(){
		alert('you lost the game');
	}
	
	
	
	
	
	
	socket.on('selfId',function(data){
		selfId = data;
	});
	
	socket.on('lobbyPlayersListUpdate',function(data){
		playersListDiv.innerHTML = "";
		for(var i = 0; i < data.length; i++){
			var player = data[i];
			if (player.id === selfId){
				playersListDiv.innerHTML += '<b>' + player.name + '</b><br>';
			} else {
				playersListDiv.innerHTML += player.name + '<br>';
			}
		}
	});
	
	socket.on('lobbyChatMessageToDisplay',function(data){
		lobbyChatDiv.innerHTML += '<div>' + data + '</div>';
		lobbyChatDiv.scrollTop = lobbyChatDiv.scrollHeight;
	});
	
	socket.on('lobbyGamesListUpdate',function(data){
		gamesListDiv.innerHTML = "";
		for(var i = 0; i < data.length; i++){
			var g = data[i];
			if (g.player2Id === ""){
				gamesListDiv.innerHTML += "<button id='" + g.id + "' style='background-color: #D8E4E8; border:0px; color: #336699; margin-left: 3px; margin-bottom: 4px; height: 30px; width: 272px;' onclick='joinGame(" + g.id + ")'>" + g.name + "'s game</button>";
			} else {
				gamesListDiv.innerHTML += "<button id='" + g.id + "' style='background-color: #D8E4E8; border:0px; color: #336699; margin-left: 3px; margin-bottom: 4px; height: 30px; width: 272px;'>" + g.name + "'s game (full)</button>";
			}
		}
	});
	
	socket.on('gamePlayersListUpdate',function(data){
		roomPlayersListDiv.innerHTML = 'Player 1: ' + data.player1.name + '<br>';
		if (data.player2 !== ""){
			roomPlayersListDiv.innerHTML += 'Player 2: ' + data.player2.name + '<br>';
		}
	});
	
	socket.on('gameID',function(data){
		gameId = data.id;
	})
	
	socket.on('kickedFromRoom',function(){
		gameId = "";
		roomScreenDiv.style.display = 'none';
		lobbyScreenDiv.style.display = 'block';
		leaveTheGameButton.style.display = 'none';
		readyGameButton.style.display = 'none';
	});
	
	socket.on('roomChatMessageToDisplay',function(data){
		roomChatDiv.innerHTML += '<div>' + data.message + '</div>';
		roomChatDiv.scrollTop = roomChatDiv.scrollHeight;
	});
	
	socket.on('gameStartButton',function(data){
		if(data.status === true){
			startGameButton.disabled = false;
		} else {
			startGameButton.disabled = true;
		}
	});
	
	socket.on('gameStarted',function(data){
		gameDiv.style.display = 'block';
		roomScreenDiv.style.display = 'none';
		playersNamesDiv.innerHTML = '<div style="color:#52E365; display:inline;">' + data.player1name + '</div><div style="color:#cccccc; display:inline;">&nbsp;vs&nbsp;</div><div style="color:#E3E152; display:inline;">' + data.player2name + '</div>';
	});
	
	
	
	
	
	
	
	
	socket.on('newPositions',function(data){
		ctx.clearRect(0,0,500,500);
		for(var i = 0; i < data.length; i++)
			ctx.fillText(data[i].number,data[i].x,data[i].y);
	});
	
	document.onkeydown = function(event){
		if(event.keyCode === 68) // d
			socket.emit('keyPress',{inputId:'right',state:true});
		else if(event.keyCode === 83) // s
			socket.emit('keyPress',{inputId:'down',state:true});
		else if(event.keyCode === 65) // a
			socket.emit('keyPress',{inputId:'left',state:true});
		else if(event.keyCode === 87) // w
			socket.emit('keyPress',{inputId:'up',state:true});
	}
	document.onkeyup = function(event){
		if(event.keyCode === 68) // d
			socket.emit('keyPress',{inputId:'right',state:false});
		else if(event.keyCode === 83) // s
			socket.emit('keyPress',{inputId:'down',state:false});
		else if(event.keyCode === 65) // a
			socket.emit('keyPress',{inputId:'left',state:false});
		else if(event.keyCode === 87) // w
			socket.emit('keyPress',{inputId:'up',state:false});
	}
</script>